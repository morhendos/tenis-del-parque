# Waiting List System - Implementation Guide\n\n## Overview\n\nThe waiting list system allows leagues with `status: 'coming_soon'` to collect player registrations before officially launching. This guide explains how the system works and how to manage waiting lists.\n\n## How the Waiting List Works\n\n### 1. **Player Registration Flow**\n\nWhen players sign up for leagues:\n- **Active Leagues** (`status: 'active'` or `'registration_open'`): Players get `status: 'pending'`\n- **Coming Soon Leagues** (`status: 'coming_soon'`): Players get `status: 'waiting'`\n\n### 2. **Data Structure**\n\nPlayers use the new **multi-league registration structure**:\n\n```javascript\n// Player Document Structure\n{\n  _id: ObjectId,\n  name: \"John Doe\",\n  email: \"john@example.com\",\n  whatsapp: \"34612345678\",\n  registrations: [{\n    league: ObjectId(\"league_id\"),\n    season: \"summer-2025\",\n    level: \"intermediate\",\n    status: \"waiting\", // 'waiting' | 'pending' | 'confirmed' | 'active' | 'inactive'\n    registeredAt: Date,\n    stats: { eloRating: 1200, ... },\n    matchHistory: [],\n    wildCards: { total: 3, used: 0 }\n  }]\n}\n```\n\n### 3. **League Counter Updates**\n\nLeague documents track player counts:\n\n```javascript\n{\n  waitingListCount: 5,  // Players with status 'waiting'\n  stats: {\n    registeredPlayers: 12, // Players with status 'pending'/'confirmed'/'active'\n    totalPlayers: 17       // All players (waiting + registered)\n  }\n}\n```\n\n## Admin Panel Management\n\n### **Viewing Waiting Lists**\n\n1. **League Overview**: Shows \"X on waiting list\" for leagues with waiting players\n2. **Click League**: Navigate to individual league page\n3. **Go to Players**: Click \"Players\" button to see all league players\n4. **Filter by Status**: Use \"Waiting\" filter to see only waiting list players\n\n### **Managing Waiting List Players**\n\n#### **Promote Players from Waiting List**\n\n1. **Navigate to Players Page**: `/admin/players?league=LEAGUE_ID`\n2. **Filter by Waiting**: Select \"Status: Waiting\" in filters\n3. **Update Status**: Click status dropdown for each player\n4. **Change to Active**: Select \"Active\" or \"Pending\" from dropdown\n5. **Automatic Updates**: League counters update automatically\n\n#### **Status Workflow**\n\n```\nwaiting → pending → confirmed → active\n   ↓         ↓         ↓         ↓\nWaiting   Need      Invited   Can Play\n List    Invite     & Ready   League\n```\n\n**Status Definitions:**\n- **waiting**: On waiting list for coming soon leagues\n- **pending**: Registered but not yet invited to create account\n- **confirmed**: Invited via WhatsApp, has activation link\n- **active**: Has created account and can log in\n- **inactive**: Manually deactivated\n\n## API Endpoints\n\n### **Get Players by League**\n```\nGET /api/admin/players?league=LEAGUE_ID&status=waiting\n```\n\n### **Update Player Status**\n```\nPATCH /api/admin/players/PLAYER_ID\nBody: {\n  \"status\": \"active\",\n  \"leagueId\": \"LEAGUE_ID\"\n}\n```\n\n## Database Queries\n\n### **Count Waiting List Players**\n```javascript\nconst waitingCount = await Player.countDocuments({ \n  'registrations': {\n    $elemMatch: {\n      'league': leagueId,\n      'status': 'waiting'\n    }\n  }\n})\n```\n\n### **Find Players by Status**\n```javascript\nconst players = await Player.aggregate([\n  { $unwind: '$registrations' },\n  { \n    $match: { \n      'registrations.league': leagueId,\n      'registrations.status': 'waiting'\n    }\n  }\n])\n```\n\n## Troubleshooting\n\n### **\"Empty Players List\" Issue**\n\n**Problem**: League shows \"3 on waiting list\" but players page is empty.\n\n**Cause**: Admin components using old player structure instead of new registrations array.\n\n**Solution**: \n1. Update admin APIs to use aggregation pipelines\n2. Add \"waiting\" status to filter components\n3. Pass league context when updating player status\n\n### **Status Not Updating**\n\n**Problem**: Changing player status doesn't update league counters.\n\n**Solution**: Ensure API calls include `leagueId` parameter:\n\n```javascript\n// ✅ Correct - includes league context\nfetch(`/api/admin/players/${playerId}`, {\n  method: 'PATCH',\n  body: JSON.stringify({ \n    status: 'active',\n    leagueId: currentLeagueId \n  })\n})\n```\n\n### **Missing Players in Filters**\n\n**Problem**: Cannot filter by \"waiting\" status.\n\n**Solution**: Add \"waiting\" option to PlayerFilters component:\n\n```javascript\n<option value=\"waiting\">Waiting</option>\n```\n\n## Workflow for League Launch\n\n### **Before Launch**\n1. League has `status: 'coming_soon'`\n2. Players register and get `status: 'waiting'`\n3. `waitingListCount` increments automatically\n4. Admin sees \"X on waiting list\" in league overview\n\n### **Launch Process**\n1. **Update League Status**: Change to `'registration_open'` or `'active'`\n2. **Promote Players**: \n   - Filter by \"Status: Waiting\"\n   - Bulk update to \"Pending\" or \"Active\"\n   - Send invitations via admin panel\n3. **Verify Counts**: Check league counters update correctly\n\n### **After Launch**\n- `waitingListCount` decreases as players are promoted\n- `stats.registeredPlayers` increases\n- Players can now be invited and create accounts\n\n## Best Practices\n\n1. **Always specify league context** when updating player status\n2. **Use aggregation pipelines** for complex player queries\n3. **Update league counters** automatically in API endpoints\n4. **Test status transitions** to ensure data consistency\n5. **Monitor league statistics** for accurate player counts\n\n## Files Modified\n\n- `components/admin/players/PlayerFilters.js` - Added \"waiting\" status option\n- `app/api/admin/players/route.js` - Support registrations structure \n- `app/api/admin/leagues/route.js` - Fix player counting\n- `app/api/admin/players/[id]/route.js` - Handle status updates\n- `lib/hooks/usePlayersData.js` - Pass league context\n\nThe waiting list system now fully supports the new multi-league player registration structure while maintaining backward compatibility with existing admin components.\n